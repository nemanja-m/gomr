syntax = "proto3";

package internal.coordinator;

option go_package = "internal/shared/proto";


service CoordinatorService {
    rpc RegisterWorker(RegisterWorkerRequest) returns (RegisterWorkerResponse);
    rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);

    rpc PullTask(PullTaskRequest) returns (PullTaskResponse);
    rpc CompleteTask(CompleteTaskRequest) returns (CompleteTaskResponse);
    rpc FailTask(FailTaskRequest) returns (FailTaskResponse);
}

// Worker registration

message RegisterWorkerRequest {
    string worker_id = 1;
    string address = 2;

    uint32 available_cpu_cores = 3;
    uint64 available_memory_bytes = 4;
}

message RegisterWorkerResponse {
    RegistrationStatus status = 1;

    string message = 2;
    int32 heartbeat_interval_seconds = 3;
}

enum RegistrationStatus {
    SUCCESS = 0;
    BAD_REQUEST = 1;
    REJECTED = 2;
    FAILED = 3;
}

// Worker heartbeat

message HeartbeatRequest {
    string worker_id = 1;
}

message HeartbeatResponse {
    bool acknowledged = 1;
}

// Task pulling

enum TaskType {
    MAP = 0;
    REDUCE = 1;
}

message PullTaskRequest {
    string worker_id = 1;
}

message PullTaskResponse {
    TaskAssignment task = 1;
}

message TaskAssignment {
    string task_id = 1;
    string job_id = 2;
    int32 attempt = 3;
    TaskType type = 4;
    TaskInput input = 5;
    TaskOutput output = 6;
    ExecutorSpec executor = 7;
}

message TaskInput {
    string type = 1;
    string format = 2;
    repeated string paths = 3;
}

message TaskOutput {
    string type = 1;
    string path = 2;
}

message ExecutorSpec {
    string type = 1;
    string uri = 2;
}

// Task completion

message CompleteTaskRequest {
    string worker_id = 1;
    string task_id = 2;
}

message CompleteTaskResponse {
    bool acknowledged = 1;
    string message = 2;
}

// Task failure

message FailTaskRequest {
    string worker_id = 1;
    string task_id = 2;
    string error = 3;
}

message FailTaskResponse {
    bool acknowledged = 1;
    string message = 2;
}